# Node.JS
За последние годы сообщество JavaScript шагнуло далеко вперед. Теперь на этом языке можно писать и серверную часть сайтов или, как еще ее называют, **backend**.

## Протокол HTTP
Связь между браузером и сервером происходит посредством протокола HTTP. Текущая и самая распространенная версия HTTP/1.1. Клиент отправляет запрос к серверу, а сервер отвечает на него. Любой запрос состоит из:

- Метода запроса (`GET`, `POST` или другой)
- Адреса запроса (с параметрами или без)
- Заголовков запроса
- Тела запроса (только для метода `POST`)

В ответ сервер присылает заголовки и тело ответа.

### Метод запроса
Самые часто используемые методы: `GET` и `POST`. Второй, в отличии от первого, позволяет передавать серверу тело запроса. Это бывает удобно в тех случаях, когда данных очень много или их не стоит афишировать (как пароль).

### Адрес запроса
Адрес запроса или URL состоит из пути (path) и параметров (query).
Данные части разделены знаком вопроса, а параметры (пара ключ=значение) разделены амперсандом.

```
www.mysite.ru/path/to/file?arg1=123&text=text
```

> Список разрешенных символов весьма мал, поэтому предусмотрен механизм URL Encode/Decode. Запрещенные символы заменяются процентом и соответствующим кодом.

### Заголовки запроса
Существует множество стандартных заголовков. Большая часть из них несет служебную информацию и браузеры сами добавляют их (например, `Content-Lenght`, `Cookie`).

### Тело запроса
В теле запроса можно передавать произвольные данные, включая двоичные (так загружаются файлы). Информацию о том как интерпретировать данные сервер получает из заголовка `Content-Type`.

## Node.JS и `npm`
Платформа Node.JS позволяет использовать язык JavaScript за пределами браузера. Node Package Manager (`npm`) в свою очередь позволяет усанавливать и удалять модули из окружения Node.

## Express
Express - это стандартный каркас для веб-приложений на Node.JS. Чтобы создать шаблон приложения, необходимо установить пакет `express-generator`:

```
$ npm install express-generator -g
```

> Опция `-g` устанавливает пакет глобально.

После этого можно создать проект:

```
$ express myproj --view ejs
$ cd myproj
$ npm install
```

> Опиция `--view` (или сокращенно `-v`) позволяет выбрать шаблонизатор. `ejs` имеет синтаксис, максимально приближенный к HTML.

Главным отличием Node.JS от браузерного JavaScript явлется функция `require()`. Она позволяет импортировать модули и js-файлы, как объекты.

Главным файлом в проекте является `app.js`. В нем создается объект приложения, настраиваются статические и динамические пути.
В файле `package.json` описано приложение и его зависимости (модули npm).

Следующая команда запустит приложение:

```
$ npm run start
```

> В данном случае `start` - название скрипта в `package.json`. Таким образом можно создавать дополнительные скрипты для запуска.

### Маршрутизация в Express
Маршрутизация используется для определения поведения приложения в зависимости от адреса, по которому обращается пользователь.

Следующий код подключает файлы из папки `routes`, как маршрутизаторы:

```javascript
var app = express();

var index = require('./routes/index');
var users = require('./routes/users');

app.use('/', index);
app.use('/users', users);
```

В этих файлах содержатся непосредственно обработчики запросов:
 
```javascript[a]
/* index.js */
var express = require('express');
var router = express.Router();

/* GET home page. */
router.get('/', function(req, res, next) {
    res.send('Hello, world!');
});

module.exports = router;
```

Таким образом по GET-запросу `http://mysite.ru/` будет вызван обработчик из кода выше. В ответ пользователь увидит `Hello, world!`.

> Запрос 'http://mysite.ru/users/all' будет направлен обработчику `/all` в файле `users.js`

Пути запросов поддерживают синтаксис, подобный регулярным выражениям. Так же в пути запроса может быть параметр, значение которого заранее не известно (начинается с `:`, только буквы, цифры и знак подчеркивания).

```javascript
router.get('/books/:id', function(req, res, next) {
    res.send('Book #' + req.params.id);
});
```

#### Статические файлы

Для статичных файлов предусмотрен механизм автоматической отправки из папки:

```javascript
app.use(express.static(path.join(__dirname, 'public')));
```

Теперь файл `public/style.css` будет доступен по адресу `http://mysite.ru/style.css`.

### Шаблонизатор `ejs`
Шаблоны позволяют заранее создать основную часть HTML страницы, а перед отправкой пользователю заполнить актуальной информацией.

Следующий код подключает шаблонизатор и устанавливает папку, в которой необходимо искать шаблоны:

```javascript
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');
```

Шаблон представляет из себя файл с расширением `.ejs`. Содержимое `<% ... %>` интерпретируется как js-код. Результат выржения в `<%= ... %>` будет подставлен в HTML. Содержимое вне скобок останется без изменений:

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Welcome, <%= name %></title>
</head>
<body>
<ul>
    <% for(var i=0; i<items.length; i++){ %>
    <li><%= items[i] %></li>
    <% } %>
</ul>
</body>
```

Для отправки страницы пользователю используется метод `render()`:

```javascript
router.get('/index', function(req, res, next) {
	 // Шаблон: pattern.ejs
    res.render('pattern', {name: 'Bob', items: ['red', 'blue', 'green']});
});
```

## Полезные ссылки
TODO